---
import { APP_LOGO_NAME, NAV_LINKS } from '../lib';
import HeaderSidebar from './HeaderSidebar.astro';
import Logo from './Logo.astro';
---

<header class="header" role="banner" transition:persist>
	<div class="container mx-auto px-4 flex justify-between items-center h-[72px]">
		<a class="logo-link" href="#home" aria-label="Home">
			<Logo />
		</a>
		<nav class="nav hidden md:block" aria-label="Main navigation">
			<ul class="nav-list flex items-center gap-8">
				{
					NAV_LINKS.map(link => (
						<li>
							<a
								class="nav-link"
								href={link.href}
								aria-label={`${link.name} section`}
								data-section={link.href.replace('#', '')}
							>
								{link.name}
							</a>
						</li>
					))
				}
			</ul>
		</nav>
		<HeaderSidebar />
	</div>
</header>

<script>
	function addNavHeight() {
		document.documentElement.style.setProperty(
			'--nav-height',
			`${document.querySelector('.header')?.clientHeight}px`
		);
	}

	function initHeader() {
		// Smooth scroll for anchor links
		document.querySelectorAll<HTMLAnchorElement>('a[href^="#"]').forEach(anchor => {
			anchor.addEventListener('click', e => {
				e.preventDefault();
				const href = anchor.getAttribute('href');
				if (!href) return;

				const target = document.querySelector(href);
				if (target) {
					const headerHeight = document.querySelector('.header')?.clientHeight || 0;
					const targetPosition =
						target.getBoundingClientRect().top + window.pageYOffset - headerHeight;

					window.scrollTo({
						top: targetPosition,
						behavior: 'smooth',
					});
				}
			});
		});

		// Active nav link highlighting
		const sections = document.querySelectorAll('section[id]');
		const navLinks = document.querySelectorAll('.nav-link[data-section]');

		const observer = new IntersectionObserver(
			entries => {
				entries.forEach(entry => {
					if (entry.isIntersecting) {
						const sectionId = entry.target.getAttribute('id');
						navLinks.forEach(link => {
							link.classList.remove('active');
							if (link.getAttribute('data-section') === sectionId) {
								link.classList.add('active');
							}
						});
					}
				});
			},
			{
				rootMargin: '-20% 0px -80% 0px',
				threshold: 0,
			}
		);

		sections.forEach(section => observer.observe(section));
	}

	// Run on initial load
	initHeader();
	addNavHeight();

	// Re-run after View Transitions navigation
	document.addEventListener('astro:after-swap', initHeader);
	document.addEventListener('astro:after-swap', addNavHeight);
</script>
